---
description: Cursor rules for a web-first monorepo: Next.js (web/SSR on Vercel) + Expo (React Native mobile), shadcn/ui for web, PostgreSQL via Prisma, Auth.js.
globs:
alwaysApply: true
---
You are a Senior Full-Stack Developer and an Expert in Next.js, React Native (Expo), TypeScript, TailwindCSS, shadcn/ui, Auth.js, Prisma, and PostgreSQL. You are thoughtful, give nuanced answers, and are brilliant at reasoning. You carefully provide accurate, factual, thoughtful answers, and are a genius at reasoning.

## Platform Strategy

**Web-first approach:** The web application (`apps/web`) is the primary, production path built with shadcn/ui (Tailwind + Radix). Mobile (`apps/mobile`) follows closely, mirroring the web design and component APIs with React Native components. Shared design tokens (`packages/theme`), API contracts (`packages/api`), and utilities (`packages/lib`) persist across both platforms.

## Codebase Structure

Follow this structure for file organization, using a **monorepo** with workspaces. Keep the `src` directory for app code inside each app. Build web components with **shadcn/ui** in `apps/web/src/components/ui`; mobile will mirror these designs later with React Native equivalents.

```plaintext
.
├── apps/
│   ├── web/                                   # Next.js (App Router) — browser/desktop
│   │   ├── src/
│   │   │   ├── app/                           # layouts, pages, API routes (server actions/route handlers)
│   │   │   │   ├── layout.tsx                 # Root layout
│   │   │   │   ├── page.tsx                   # Home
│   │   │   │   ├── (auth)/                    # Auth routes (web UX)
│   │   │   │   │   ├── login/page.tsx
│   │   │   │   │   └── signup/page.tsx
│   │   │   │   ├── feature-one/
│   │   │   │   │   ├── page.tsx               # Feature pages
│   │   │   │   │   ├── new/page.tsx
│   │   │   │   │   └── [itemId]/page.tsx
│   │   │   │   ├── feature-two/
│   │   │   │   │   ├── layout.tsx
│   │   │   │   │   └── [featureTwoId]/page.tsx
│   │   │   │   └── api/                       # Server-only code
│   │   │   │       ├── auth/[...nextauth]/route.ts    # Auth.js handler (PrismaAdapter)
│   │   │   │       ├── feature-one/route.ts           # Prisma-backed endpoints
│   │   │   │       └── feature-two/route.ts
│   │   │   ├── components/                    # Web components
│   │   │   │   └── ui/                        # shadcn/ui components
│   │   │   │       ├── atoms/                 # Atomic components (fundamental building blocks)
│   │   │   │       ├── molecules/             # Composite components (combinations of atoms)
│   │   │   │       ├── organisms/             # Complex components (optional, for larger compositions)
│   │   │   │       └── shadcn/                # Direct shadcn/ui components (button.tsx, input.tsx, etc.)
│   │   │   │           ├── button.tsx
│   │   │   │           ├── input.tsx
│   │   │   │           └── ...
│   │   │   ├── styles/                        # Tailwind entry (globals.css with shadcn tokens)
│   │   │   └── lib/                           # Web utils (RSC helpers, caching, revalidate, cn helper)
│   │   ├── components.json                    # shadcn/ui configuration
│   │   ├── next.config.mjs                    # Web-only config (no RN coupling)
│   │   └── tailwind.config.ts                 # Consumes shared preset from packages/theme
│   │
│   └── mobile/                                # Expo (iOS/Android) — mirrors web design
│       ├── app/                               # Expo Router (file-based)
│       │   ├── _layout.tsx                    # Navigation container, Safe Areas
│       │   ├── index.tsx                      # Home screen (mirrors web)
│       │   ├── feature-one/index.tsx
│       │   └── feature-two/[featureTwoId].tsx
│       ├── components/                        # Mobile components (mirror web design with RN)
│       ├── app.config.ts                      # Expo app config
│       └── tailwind.config.js                 # NativeWind config (extends shared preset)
│
├── packages/
│   ├── ui/                                    # React Native UI components (for mobile)
│   │   ├── src/
│   │   │   ├── atoms/                         # Fundamental building blocks
│   │   │   │   ├── Button/
│   │   │   │   │   ├── Button.tsx             # Default universal impl (uses RN primitives)
│   │   │   │   │   ├── Button.web.tsx         # Web-specific override (e.g., focus ring, tooltip)
│   │   │   │   │   ├── Button.native.tsx      # Mobile-specific override (e.g., haptics)
│   │   │   │   │   ├── Button.test.tsx
│   │   │   │   │   └── index.ts
│   │   │   │   ├── Input/
│   │   │   │   ├── Typography/
│   │   │   │   └── ...
│   │   │   ├── molecules/                     # Combinations of atoms (forms, menu items)
│   │   │   ├── organisms/                     # Complex components (auth, navigation, cards)
│   │   │   ├── templates/                     # Cross-platform layouts/structures
│   │   │   └── providers/                     # Theme, SafeArea, Gesture handlers
│   │   └── package.json
│   │
│   ├── screens/                               # Route-agnostic feature screens (mobile)
│   │   ├── feature-one/
│   │   │   ├── components/
│   │   │   ├── hooks/
│   │   │   │   └── __tests__/useFeatureOne.test.ts
│   │   │   └── FeatureOneScreen.tsx           # Mobile screen components
│   │   └── feature-two/
│   │       └── FeatureTwoScreen.tsx
│   │
│   ├── theme/                                 # Design tokens shared across web/mobile
│   │   ├── tailwind-preset.cjs                # Consumed by web & NativeWind
│   │   └── tokens.ts                          # Colors/spacing/typography
│   │
│   ├── api/                                   # Shared API contracts/clients
│   │   ├── schemas/                           # Zod schemas, DTOs
│   │   ├── client.ts                          # fetch wrappers / TanStack Query setup
│   │   └── types.ts
│   │
│   └── lib/                                   # Shared utilities, formatters, constants
│
├── prisma/
│   ├── schema.prisma
│   └── migrations/                            # Generated by Prisma
│
├── services/                                  # Server-side wiring (imported by apps/web)
│   └── db/
│       ├── db-client.ts                       # Prisma singleton (avoid hot-reload leaks)
│       └── auth.ts                            # Auth.js config/helpers (PrismaAdapter)
│
├── e2e/
│   ├── web/                                   # Playwright tests (web)
│   │   ├── tests/
│   │   │   ├── auth.spec.ts
│   │   │   └── feature-one.spec.ts
│   │   ├── fixtures/
│   │   ├── playwright.config.ts
│   │   └── global-setup.ts
│   └── mobile/                                # Optional: Detox/Maestro (mobile)
│       └── README.md
│
├── public/                                    # Static assets (web)
├── docs/
│   ├── ui/
│   │   └── shadcn.md                          # shadcn/ui documentation
│   └── features/
│       ├── featureOne.md
│       └── featureTwo.md
└── (root config files omitted for brevity: .gitignore, package.json, turbo.json, tsconfig.*, .env, etc.)
```

> **Platform note:** Build web components with **shadcn/ui** in `apps/web/src/components/ui`. These are Tailwind-first, copy-paste components that live in your codebase. Mobile will mirror the design and component APIs later using React Native components. No React Native Web coupling in the web app.

## General Coding Practices

- **DRY:** Check `/packages/api`, `/packages/lib`, `/packages/theme`, `/services`, and feature folders before coding.
- **Single Responsibility (SRP)** and **Consistency** across components and modules.
- **Tailwind:** Use utility classes; extend via shared **theme preset** (`packages/theme/tailwind-preset.cjs`).
- **Clean Code:** Small components; remove dead code aggressively. Document non-obvious logic/props.
- **Local First:** Start in feature/screen; promote to shared packages upon reuse.
- **Testing:** Unit tests (utilities/hooks), RTL for components/screens, Playwright (web), optional Detox/Maestro (mobile). Run relevant tests locally before committing.
- **Docs:** Record key decisions and edge cases in `docs/`.

## React (Web + Mobile) Guidelines

- Default to **Server Components** in Next.js; use Client Components (`'use client'`) for interactivity/browser APIs.
- **Routing:** Expo Router (mobile) and Next App Router (web). Keep route files thin wrappers.
- **State & Data:** Prefer TanStack Query/Zustand per feature; avoid global state unless necessary.
- **Effects:** Only for side effects; compute derived values instead of storing. Use `useMemo` sparingly.
- **Validation:** Enforce **Zod** at API boundaries (route handlers/server actions).

## Dependency Hygiene

- Stick to declared deps; discuss before adding new ones.
- Core web: `next`, `react`, `tailwindcss`, `@tanstack/react-query`, `shadcn/ui` (via CLI), `tailwindcss-animate`.
- Core mobile: `expo`, `react-native`, `nativewind`, `expo-router`, `react-native-gesture-handler`, `react-native-reanimated`.
- Cross-platform: `zod`, `zustand` (optional).
- Backend: `prisma`, `@prisma/client`, `next-auth`/`@auth/core`, `@auth/prisma-adapter`.
- Avoid Node-only deps in edge runtimes; keep Prisma on Node runtime unless using Data Proxy.

## Naming Conventions

- **Components:** `PascalCase` (e.g., `UserProfile.tsx`)
- **Pages/Routes:** `page.tsx`, `layout.tsx`, `loading.tsx`, `error.tsx`, `route.ts`
  - Folders: `lowercase`/`kebab-case` (`user-settings/`)
  - Dynamic: `[slug]`; Route Groups: `(group)`
- **Non-components (utils/hooks/config):** `kebab-case` (`auth-helpers.ts`, `use-user-data.ts`)
- **Folders (non-routing):** `kebab-case` (`components/`, `lib/`)
- **Variables/Functions:** `camelCase`
- **Types/Interfaces:** `PascalCase`
- **Constants:** `UPPER_SNAKE_CASE`
- **Prisma Models:** `PascalCase` (tables via Prisma)

## Data Layer (PostgreSQL + Prisma)

- Define schema in `prisma/schema.prisma`; generate with `npx prisma generate`.
- Migrations: `prisma migrate dev` locally; `prisma migrate deploy` in Vercel.
- **Server-only access:** Run Prisma in **Next route handlers/server actions** (apps/web). Do **not** bundle Prisma in client or mobile.
- Use a **Prisma client singleton** (`services/db/db-client.ts`) to avoid hot-reload leaks.
- Validate inputs with Zod before DB ops.

## Auth (Auth.js)

- Adapter: **PrismaAdapter** with database sessions.
- Handler: `apps/web/src/app/api/auth/[...nextauth]/route.ts`.
- **Web:** Cookie sessions; `getServerSession()` (server) and `useSession()` (client).
- **Mobile:** Treat RN app as an API consumer. Implement OAuth (PKCE) or credentials routes in Next; store tokens securely on device. **Do not** use NextAuth client in RN. Share user schemas/types in `packages/api`.

## UI (Tailwind + shadcn/ui)

- **Web UI Structure:** Organize components in `apps/web/src/components/ui` using atomic design principles:
  - **`atoms/`** - Fundamental building blocks (e.g., `DropdownElement`, `IconButton`). Each atom lives in its own PascalCase folder with:
    - `ComponentName.tsx` - Component implementation
    - `ComponentName.test.tsx` - Tests
    - `index.ts` - Barrel export
  - **`molecules/`** - Composite components combining atoms (e.g., `SettingsMenu`). Same folder structure as atoms.
  - **`organisms/`** - Complex components (optional, for larger compositions). Same folder structure.
  - **Direct shadcn components** - shadcn/ui components added via CLI live in `ui/shadcn/` (e.g., `shadcn/button.tsx`, `shadcn/input.tsx`).
- **Component usage:** 
  - Atoms/molecules: Import from `@/components/ui/atoms/ComponentName` or `@/components/ui/molecules/ComponentName`
  - shadcn components: Import from `@/components/ui/shadcn/<component>` (e.g., `@/components/ui/shadcn/button`)
- **Styling:** Use Tailwind utility classes; extend via shared **theme preset** (`packages/theme/tailwind-preset.cjs`). shadcn components use CSS variables defined in `apps/web/src/styles/globals.css`.
- **Mobile UI:** Build React Native components in `apps/mobile/components` that mirror web design. Use shared design tokens from `packages/theme` for consistency.
- **No cross-platform UI coupling:** Web does not use React Native Web. Mobile mirrors web design independently.

## Monorepo & Platform Integration

- **Workspaces & Build:** npm/pnpm/yarn workspaces + Turborepo.
- **Next config (`apps/web/next.config.mjs`):**
  - `transpilePackages: ['@repo/api', '@repo/lib', '@repo/theme']` (shared packages only)
  - No React Native Web alias or transpilation.
- **Expo & NativeWind:**
  - Configure NativeWind; extend Tailwind with `packages/theme/tailwind-preset.cjs`.
  - Fonts: load via `expo-font` (mobile) and Next fonts (web).
- **Gestures/Animation:** Ensure `react-native-gesture-handler` & `react-native-reanimated` are configured for mobile; web uses standard CSS/JS animations.

## Environment & Deployment (Vercel)

- Env vars: `DATABASE_URL`, `AUTH_SECRET`, OAuth provider keys. Never commit `.env`.
- Vercel build: run `prisma migrate deploy` (build/post-deploy). Use **Node runtime** for handlers using Prisma.
- Consider Prisma Data Proxy or pooled Postgres for connection limits.
- Static assets via `public/` (web). Mobile assets via Expo pipeline (bundled).

## Debugging & Issue Resolution

- Reproduce, isolate, and fix one issue at a time.
- Minimal, precise changes; verify via tests/manual checks.
- Avoid unrelated refactors in bug-fix commits.
- For DB: inspect Prisma logs, check migration drift, confirm schema alignment.
- For web UI: test components in isolation, verify Tailwind classes, check shadcn component props/docs.

# Notes
- Use **shadcn/ui** components as the foundation for web UI—they're maintainable, accessible, and Tailwind-first.
- Mobile mirrors web design using React Native components; shared tokens ensure consistency.
- Favor **server actions/route handlers** for data mutations over client-side writes.
- Treat **design tokens** as the single source of truth (colors/spacing/typography) across platforms.
