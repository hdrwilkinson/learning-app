// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// AUTH.JS REQUIRED MODELS
// =============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress    String?
  userAgent    String?
  deviceName   String?
  location     String?
  createdAt    DateTime @default(now())
  lastAccessed DateTime @default(now())

  @@index([userId])
  @@index([userId, lastAccessed])
}

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?
  password      String?
  username      String?  @unique
  bio           String?
  dateOfBirth   DateTime?
  country       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  accounts          Account[]
  sessions          Session[]
  courseMemberships CourseMembership[]
  groupMemberships  GroupMembership[]
  loginHistory      LoginHistory[]
  knownDevices      KnownDevice[]
  courseRatings     CourseRating[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

// =============================================================================
// LOGIN HISTORY & DEVICE TRACKING
// =============================================================================

model LoginHistory {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress  String?
  userAgent  String?
  deviceName String?
  location   String?
  loginAt    DateTime @default(now())
  sessionId  String?

  @@index([userId, loginAt])
}

model KnownDevice {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceHash  String
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  @@unique([userId, deviceHash])
  @@index([userId])
}

// =============================================================================
// COURSE STRUCTURE
// =============================================================================

model Course {
  id               String                 @id @default(cuid())
  title            String
  description      String?                @db.Text
  topic            String?
  imageUrl         String?
  visibility       CourseVisibility       @default(PRIVATE)
  generationStatus CourseGenerationStatus @default(PENDING)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  // Rating & time estimates (denormalized for performance)
  averageRating         Float? // 0-5 scale, null if no ratings
  ratingCount           Int    @default(0)
  estimatedMinutesPerIP Int    @default(30) // For time estimates

  // Relations
  modules     Module[]
  memberships CourseMembership[]
  groups      CourseGroup[]
  ratings     CourseRating[]
}

enum CourseVisibility {
  PRIVATE // Only members can see
  PUBLIC  // Anyone can discover and join
}

enum CourseGenerationStatus {
  PENDING    // Course creation initiated, not yet generating
  GENERATING // AI is generating content
  COMPLETED  // Generation finished successfully
  FAILED     // Generation encountered an error
}

// =============================================================================
// COURSE ACCESS & MEMBERSHIP
// =============================================================================

model CourseMembership {
  id           String     @id @default(cuid())
  userId       String
  courseId     String
  courseRole   CourseRole
  learningGoal String?    @db.Text // User's objective for this course
  schedule     Json?      // { daysPerWeek: string[], minutesPerSession: number }
  joinedAt     DateTime   @default(now())

  // Notification preferences
  emailReminders      Boolean @default(true)
  pushNotifications   Boolean @default(true)
  weeklyProgressEmail Boolean @default(true)

  // Privacy preferences
  showProgressToGroup  Boolean @default(true)
  appearInLeaderboards Boolean @default(true)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

enum CourseRole {
  CREATOR // Full control, can delete course
  ADMIN   // Can manage members, edit content
  STUDENT // Can learn, take quizzes
}

model CourseGroup {
  id         String          @id @default(cuid())
  courseId   String
  name       String
  isDefault  Boolean         @default(false)
  joinPolicy GroupJoinPolicy @default(INVITE_ONLY)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  // Relations
  course      Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  memberships GroupMembership[]

  @@index([courseId])
}

enum GroupJoinPolicy {
  OPEN          // Anyone in the course can join this group
  MEMBER_INVITE // Any group member can invite others
  LEADER_ONLY   // Only group leaders can invite
  INVITE_ONLY   // Only course admins/creators can add members
}

model GroupMembership {
  id        String    @id @default(cuid())
  userId    String
  groupId   String
  groupRole GroupRole
  joinedAt  DateTime  @default(now())

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  group CourseGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

enum GroupRole {
  LEADER // Can view group progress, lead discussions
  MEMBER // Regular group member
}

model CourseRating {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int // 1-5 scale
  review    String?  @db.Text // Optional written review

  // Reviewer's progress snapshot at time of review
  completionPercent Float // % of IPs introduced (0-100)
  masteryPercent    Float // Average mastery across attempted IPs (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId]) // One rating per user per course
  @@index([courseId])
  @@index([userId])
}

// =============================================================================
// CONTENT HIERARCHY
// =============================================================================

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?  @db.Text
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@unique([courseId, order])
  @@index([courseId])
}

model Lesson {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  description String?  @db.Text
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module            Module             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  informationPoints InformationPoint[]

  @@unique([moduleId, order])
  @@index([moduleId])
}

model InformationPoint {
  id        String   @id @default(cuid())
  lessonId  String
  typeId    String?
  title     String
  content   String   @db.Text
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lesson             Lesson                        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  type               InformationPointType?         @relation(fields: [typeId], references: [id])
  progress           InformationPointProgress[]
  questions          GeneratedQuestion[]
  availableQuizTypes InformationPointQuizType[]
  prerequisites      InformationPointPrerequisite[] @relation("dependent")
  dependents         InformationPointPrerequisite[] @relation("prerequisite")

  @@unique([lessonId, order])
  @@index([lessonId])
  @@index([typeId])
}

// =============================================================================
// LOOKUP TABLES
// =============================================================================

model InformationPointType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  informationPoints InformationPoint[]
}

model QuizType {
  id                     String   @id @default(cuid())
  name                   String   @unique
  displayName            String
  description            String?
  difficultyWeight       Float    // Relative difficulty (1.0 = baseline)
  minMasteryToUnlock     Float    // Mastery level required to unlock (0-1)
  masteryBoostOnCorrect  Float    // Added to mastery on correct answer
  stabilityMultiplier    Float    // Multiplier for stability increase
  applicableContentTypes String[] // e.g., ['text', 'code', 'math']
  requiresLLMGrading     Boolean  @default(false)
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  informationPointQuizTypes InformationPointQuizType[]
  generatedQuestions        GeneratedQuestion[]
  quizResponses             QuizResponse[]
}

// =============================================================================
// JUNCTION TABLES
// =============================================================================

model InformationPointQuizType {
  id                 String @id @default(cuid())
  informationPointId String
  quizTypeId         String

  // Relations
  informationPoint InformationPoint @relation(fields: [informationPointId], references: [id], onDelete: Cascade)
  quizType         QuizType         @relation(fields: [quizTypeId], references: [id], onDelete: Cascade)

  @@unique([informationPointId, quizTypeId])
  @@index([informationPointId])
  @@index([quizTypeId])
}

model InformationPointPrerequisite {
  id             String   @id @default(cuid())
  prerequisiteId String   // The IP that must be learned first
  dependentId    String   // The IP that requires the prerequisite
  createdAt      DateTime @default(now())

  // Relations
  prerequisite InformationPoint @relation("prerequisite", fields: [prerequisiteId], references: [id], onDelete: Cascade)
  dependent    InformationPoint @relation("dependent", fields: [dependentId], references: [id], onDelete: Cascade)

  @@unique([prerequisiteId, dependentId])
  @@index([prerequisiteId])
  @@index([dependentId])
}

// =============================================================================
// PROGRESS & MASTERY TRACKING
// =============================================================================

model InformationPointProgress {
  id                 String        @id @default(cuid())
  userId             String
  informationPointId String
  state              ProgressState @default(UNSEEN)

  // Dual-track mastery
  masteryLevel       Float    @default(0) // Current understanding (0-1), volatile
  baselineMastery    Float    @default(0) // Long-term average (0-1), stable
  baselineConfidence Float    @default(0) // Reliability of baseline (0-1)
  stability          Float    @default(1) // Days until ~90% forgetting probability
  nextReviewAt       DateTime?            // When system will next present this IP

  // Performance stats
  totalAttempts  Int @default(0)
  correctAttempts Int @default(0)
  currentStreak  Int @default(0) // Consecutive correct answers
  lapseCount     Int @default(0) // Times dropped from 'mastered' state

  // Timestamps
  introducedAt   DateTime? // When Learn mode completed
  lastReviewedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  informationPoint InformationPoint @relation(fields: [informationPointId], references: [id], onDelete: Cascade)

  @@unique([userId, informationPointId])
  @@index([userId])
  @@index([informationPointId])
  @@index([nextReviewAt])
}

enum ProgressState {
  UNSEEN    // Never introduced
  LEARNING  // In Learn mode, not yet quiz-eligible
  REVIEWING // Being actively quizzed
  MASTERED  // Reached mastery threshold
}

// =============================================================================
// QUIZ SYSTEM
// =============================================================================

model GeneratedQuestion {
  id                 String             @id @default(cuid())
  informationPointId String
  quizTypeId         String
  questionText       String             @db.Text
  difficulty         QuestionDifficulty

  // Type-specific fields (nullable based on quiz type)
  correctAnswer        Boolean?  // True/False
  options              Json?     // Multiple Choice: [{text, isCorrect, whyWrong}]
  correctOptionIndex   Int?      // Multiple Choice
  expectedAnswer       String?   @db.Text // Q&A
  gradingRubric        Json?     // Q&A: {fullCreditCriteria, partialCreditCriteria, commonMistakes}
  keyPoints            String[]  // Q&A: Points that must be in answer
  acceptableVariations String[]  // Q&A: Acceptable terminology variations
  explanation          String?   @db.Text

  // Generation metadata
  generatedAt       DateTime     @default(now())
  modelUsed         String?
  generationBatchId String?
  isActive          Boolean      @default(true)
  reviewStatus      ReviewStatus @default(PENDING)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  informationPoint InformationPoint @relation(fields: [informationPointId], references: [id], onDelete: Cascade)
  quizType         QuizType         @relation(fields: [quizTypeId], references: [id])
  responses        QuizResponse[]

  @@index([informationPointId])
  @@index([quizTypeId])
  @@index([generationBatchId])
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

model QuizResponse {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  quizTypeId String
  sessionId  String?  // Groups responses in a study session

  // Response data
  userAnswer String  @db.Text
  isCorrect  Boolean
  responseTimeMs Int? // Milliseconds

  // State snapshot (before response)
  masteryBefore   Float?
  baselineBefore  Float?
  stabilityBefore Float?

  createdAt DateTime @default(now())

  // Relations
  question GeneratedQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  quizType QuizType          @relation(fields: [quizTypeId], references: [id])

  @@index([userId])
  @@index([questionId])
  @@index([quizTypeId])
  @@index([sessionId])
  @@index([createdAt])
}

// =============================================================================
// CURIOSITY CHAT
// =============================================================================

model CuriosityChat {
  id            String             @id @default(cuid())
  userId        String
  title         String
  summary       String?            @db.Text // AI-generated summary
  savedToCourse Boolean            @default(false)
  courseId      String?
  archived      Boolean            @default(false) // Soft delete
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  // Relations
  messages CuriosityMessage[]

  @@index([userId])
  @@index([userId, updatedAt])
  @@index([userId, archived])
}

model CuriosityMessage {
  id        String   @id @default(cuid())
  chatId    String
  role      String   // 'user' or 'assistant'
  content   String   @db.Text
  parts     Json?    // AI SDK v6 parts array (tool calls, etc.)
  createdAt DateTime @default(now())

  // Relations
  chat CuriosityChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([chatId, createdAt])
}
